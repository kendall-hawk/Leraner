<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <meta name="description" content="Professional English Learning Platform with Audio Sync and Smart Vocabulary">
    <title>English Learning Platform</title>
    
    <!-- PWAé…ç½® -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2196F3">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    
    <!-- æ ·å¼æ–‡ä»¶ -->
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/mobile.css">
    
    <!-- åœ¨index.htmlçš„<head>ä¸­æ·»åŠ å…¼å®¹æ€§è„šæœ¬ -->
    <script src="js/utils/compatibility.js"></script>
    
    <!-- é¢„åŠ è½½å…³é”®èµ„æº -->
    <link rel="preload" href="js/foundation/state-manager.js" as="script">
    <link rel="preload" href="js/foundation/event-hub.js" as="script">
    <link rel="preload" href="data/config/app-config.json" as="fetch">
</head>
<body>
    <!-- ğŸŒŸ ä¸»åº”ç”¨å®¹å™¨ -->
    <div id="app-container" class="app-container">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <header class="app-header">
            <div class="header-content">
                <h1 class="app-title">ğŸ“š English Learning</h1>
                <button id="menu-toggle" class="menu-toggle" aria-label="æ‰“å¼€èœå•">
                    <span class="hamburger"></span>
                </button>
            </div>
        </header>
        
        <!-- å¯¼èˆªä¾§è¾¹æ  -->
        <nav id="nav-container" class="nav-container" aria-label="ä¸»å¯¼èˆª"></nav>
        
        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <main id="content-area" class="content-area">
            <!-- æ¬¢è¿å±å¹• -->
            <div class="welcome-screen">
                <div class="welcome-content">
                    <h2>ğŸ¯ Welcome to English Learning Platform</h2>
                    <p>Professional language learning with audio synchronization and smart vocabulary tools.</p>
                    
                    <div class="feature-grid">
                        <div class="feature-card">
                            <div class="feature-icon">ğŸ§</div>
                            <h3>Audio Sync</h3>
                            <p>Real-time text highlighting with audio playback</p>
                        </div>
                        
                        <div class="feature-card">
                            <div class="feature-icon">ğŸ“–</div>
                            <h3>Smart Vocabulary</h3>
                            <p>Context-aware word definitions and examples</p>
                        </div>
                        
                        <div class="feature-card">
                            <div class="feature-icon">ğŸ“Š</div>
                            <h3>Progress Tracking</h3>
                            <p>Personalized learning analytics and recommendations</p>
                        </div>
                        
                        <div class="feature-card">
                            <div class="feature-icon">ğŸ“±</div>
                            <h3>Mobile Optimized</h3>
                            <p>Perfect experience on all devices</p>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button id="start-learning" class="btn-primary">Start Learning</button>
                        <button id="browse-content" class="btn-secondary">Browse Content</button>
                    </div>
                </div>
            </div>
            
            <!-- æ–‡ç« å†…å®¹åŒºåŸŸ -->
            <article id="article-content" class="article-content hidden">
                <header class="article-header">
                    <h1 id="article-title">Article Title</h1>
                    <div class="article-meta">
                        <span id="article-difficulty" class="difficulty-badge">â­â­â­</span>
                        <span id="article-time" class="time-badge">5 min read</span>
                        <span id="article-words" class="words-badge">150 words</span>
                    </div>
                </header>
                
                <div id="article-body" class="article-body">
                    <!-- æ–‡ç« å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                </div>
                
                <footer class="article-footer">
                    <div class="article-actions">
                        <button id="prev-article" class="nav-btn">â† Previous</button>
                        <button id="bookmark-article" class="bookmark-btn">ğŸ”– Bookmark</button>
                        <button id="next-article" class="nav-btn">Next â†’</button>
                    </div>
                </footer>
            </article>
        </main>
        
        <!-- éŸ³é¢‘æ’­æ”¾å™¨ -->
        <div id="audio-container" class="audio-container">
            <div class="audio-player">
                <audio id="audio-player" preload="none">
                    Your browser does not support audio playback.
                </audio>
                
                <div class="audio-controls">
                    <button id="play-pause" class="control-btn" aria-label="æ’­æ”¾/æš‚åœ">
                        <span class="play-icon">â–¶ï¸</span>
                    </button>
                    
                    <div class="audio-progress">
                        <input type="range" id="progress-slider" class="progress-slider" 
                               min="0" max="100" value="0" aria-label="æ’­æ”¾è¿›åº¦">
                        <div class="time-display">
                            <span id="current-time">0:00</span>
                            <span id="duration">0:00</span>
                        </div>
                    </div>
                    
                    <div class="audio-settings">
                        <button id="speed-control" class="control-btn" aria-label="æ’­æ”¾é€Ÿåº¦">1x</button>
                        <button id="volume-control" class="control-btn" aria-label="éŸ³é‡æ§åˆ¶">ğŸ”Š</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ğŸ”„ åˆå§‹åŠ è½½å±å¹• -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
            <div class="app-logo">ğŸ“š</div>
            <h2>English Learning Platform</h2>
            <div class="loading-animation">
                <div class="loading-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
            <p id="loading-status">Initializing application...</p>
        </div>
    </div>
    
    <!-- ğŸš¨ é”™è¯¯æç¤º -->
    <div id="error-toast" class="error-toast hidden">
        <div class="toast-content">
            <span id="toast-message">Error message</span>
            <button id="toast-close" class="toast-close">Ã—</button>
        </div>
    </div>
    
    <!-- ğŸ¯ è¿”å›é¡¶éƒ¨æŒ‰é’® -->
    <button id="back-to-top" class="back-to-top hidden" aria-label="è¿”å›é¡¶éƒ¨">â†‘</button>
    
    <!-- JavaScript æ¨¡å—åŠ è½½ -->
    <!-- Foundation Layer - æŒ‰æ­£ç¡®é¡ºåºåŠ è½½ -->
    <script src="js/foundation/state-manager.js"></script>
    <script src="js/foundation/event-hub.js"></script>
    <script src="js/foundation/cache-manager.js"></script>
    <script src="js/foundation/error-boundary.js"></script>
    
    <!-- Core Modules Layer -->
    <script src="js/modules/navigation-core.js"></script>
    <script src="js/modules/audio-sync-core.js"></script>
    <script src="js/modules/glossary-core.js"></script>
    <script src="js/modules/word-frequency-core.js"></script>
    <script src="js/modules/app-controller.js"></script>
    <script src="main.js" defer></script>
    <!-- åº”ç”¨åˆå§‹åŒ– -->
    <script>
        // ğŸš€ ç”Ÿäº§æ¨¡å¼åº”ç”¨åˆå§‹åŒ–
        (function() {
            'use strict';
            
            // å…¨å±€åº”ç”¨çŠ¶æ€
            window.appState = {
                isInitialized: false,
                currentArticle: null,
                isLoading: false
            };
            
            // ç­‰å¾…DOMåŠ è½½å®Œæˆ
            document.addEventListener('DOMContentLoaded', initializeApp);
            
            function initializeApp() {
                console.log('ğŸš€ Starting English Learning Platform...');
                
                try {
                    // æ£€æŸ¥å¿…éœ€æ¨¡å—
                    if (!validateModules()) {
                        throw new Error('Required modules not loaded');
                    }
                    
                    // é…ç½®åº”ç”¨
                    const appConfig = {
                        name: 'EnglishLearningPlatform',
                        version: '2.0.0',
                        debug: false,
                        autoStart: true,
                        startupTimeout: 10000,
                        modules: {
                            navigation: {
                                container: 'nav-container',
                                enableBreadcrumb: true,
                                enableSearch: true,
                                breakpoint: 768
                            },
                            audioSync: {
                                contentArea: 'content-area',
                                audioPlayer: 'audio-player',
                                highlightClass: 'audio-highlight',
                                scrollBehavior: 'smooth'
                            },
                            glossary: {
                                container: 'content-area',
                                triggerEvent: 'click',
                                enableBookmark: true,
                                enableAudio: true,
                                maxWidth: 350,
                                autoClose: true
                            },
                            wordFrequency: {
                                enablePersonalization: true,
                                enableRealTimeAnalysis: false,
                                cacheTimeout: 24 * 60 * 60 * 1000
                            }
                        }
                    };
                    
                    // åˆ›å»ºåº”ç”¨å®ä¾‹
                    window.app = new AppController(appConfig);
                    
                    // ç»‘å®šUIäº‹ä»¶
                    bindUIEvents();
                    
                    // åŠ è½½åˆå§‹æ•°æ®
                    loadInitialData();
                    
                    console.log('âœ… Application initialized successfully');
                    
                } catch (error) {
                    console.error('âŒ Application initialization failed:', error);
                    showErrorToast('åº”ç”¨åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                    
                    // æ˜¾ç¤ºé™çº§ç•Œé¢
                    showFallbackUI();
                }
            }
            
            function validateModules() {
                const requiredModules = [
                    'StateManager', 'EventHub', 'CacheManager', 'ErrorBoundary',
                    'NavigationCore', 'AudioSyncCore', 'GlossaryCore', 
                    'WordFrequencyCore', 'AppController'
                ];
                
                for (let module of requiredModules) {
                    if (!window.EnglishSite || !window.EnglishSite[module]) {
                        console.error('âŒ Missing module:', module);
                        return false;
                    }
                }
                
                return true;
            }
            
            function bindUIEvents() {
                // èœå•åˆ‡æ¢
                const menuToggle = document.getElementById('menu-toggle');
                if (menuToggle) {
                    menuToggle.addEventListener('click', function() {
                        if (window.app && window.app.getModule('NavigationCore')) {
                            window.app.getModule('NavigationCore').toggle();
                        }
                    });
                }
                
                // å¼€å§‹å­¦ä¹ æŒ‰é’®
                const startLearning = document.getElementById('start-learning');
                if (startLearning) {
                    startLearning.addEventListener('click', function() {
                        loadFirstArticle();
                    });
                }
                
                // æµè§ˆå†…å®¹æŒ‰é’®
                const browseContent = document.getElementById('browse-content');
                if (browseContent) {
                    browseContent.addEventListener('click', function() {
                        if (window.app && window.app.getModule('NavigationCore')) {
                            window.app.getModule('NavigationCore').open();
                        }
                    });
                }
                
                // è¿”å›é¡¶éƒ¨æŒ‰é’®
                const backToTop = document.getElementById('back-to-top');
                if (backToTop) {
                    backToTop.addEventListener('click', function() {
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    });
                    
                    // æ»šåŠ¨æ˜¾ç¤º/éšè—è¿”å›é¡¶éƒ¨æŒ‰é’®
                    window.addEventListener('scroll', function() {
                        if (window.pageYOffset > 300) {
                            backToTop.classList.remove('hidden');
                        } else {
                            backToTop.classList.add('hidden');
                        }
                    });
                }
                
                // é”™è¯¯æç¤ºå…³é—­
                const toastClose = document.getElementById('toast-close');
                if (toastClose) {
                    toastClose.addEventListener('click', function() {
                        document.getElementById('error-toast').classList.add('hidden');
                    });
                }
            }
            
            async function loadInitialData() {
                try {
                    // éšè—åŠ è½½å±å¹•
                    setTimeout(() => {
                        const loadingScreen = document.getElementById('loading-screen');
                        if (loadingScreen) {
                            loadingScreen.style.opacity = '0';
                            setTimeout(() => {
                                loadingScreen.style.display = 'none';
                            }, 500);
                        }
                    }, 1500);
                    
                    // æ ‡è®°åº”ç”¨å·²åˆå§‹åŒ–
                    window.appState.isInitialized = true;
                    
                } catch (error) {
                    console.error('âŒ Failed to load initial data:', error);
                    showErrorToast('æ•°æ®åŠ è½½å¤±è´¥');
                }
            }
            
            function loadFirstArticle() {
                // è¿™é‡Œå°†æ¥ä¼šåŠ è½½ç¬¬ä¸€ç¯‡æ–‡ç« 
                showErrorToast('æ–‡ç« åŠ è½½åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...');
            }
            
            function showErrorToast(message) {
                const toast = document.getElementById('error-toast');
                const messageEl = document.getElementById('toast-message');
                
                if (toast && messageEl) {
                    messageEl.textContent = message;
                    toast.classList.remove('hidden');
                    
                    // 3ç§’åè‡ªåŠ¨éšè—
                    setTimeout(() => {
                        toast.classList.add('hidden');
                    }, 3000);
                }
            }
            
            function showFallbackUI() {
                const loadingScreen = document.getElementById('loading-screen');
                const loadingStatus = document.getElementById('loading-status');
                
                if (loadingScreen && loadingStatus) {
                    loadingStatus.textContent = 'âŒ åº”ç”¨åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';
                    loadingScreen.style.background = '#f44336';
                }
            }
            
            // å…¨å±€é”™è¯¯å¤„ç†
            window.addEventListener('error', function(event) {
                console.error('Global error:', event.error);
                showErrorToast('ç³»ç»Ÿé”™è¯¯: ' + event.error.message);
            });
            
            window.addEventListener('unhandledrejection', function(event) {
                console.error('Unhandled promise rejection:', event.reason);
                showErrorToast('ç³»ç»Ÿé”™è¯¯: Promise rejected');
            });
            
        })();
    </script>
</body>
</html>