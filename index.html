<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="LearnerEn">
    <meta name="format-detection" content="telephone=no">
    <meta name="theme-color" content="#007AFF">
    
    <title>LearnerEn - 英语学习平台</title>
    
    <!-- 预加载关键资源 -->
    <link rel="preload" href="css/base.css" as="style">
    <link rel="preload" href="js/main.js" as="script">
    <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
    
    <!-- PWA支持 -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="assets/icons/icon-180.png">
    
    <!-- 样式文件 -->
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/mobile.css">
    <link rel="stylesheet" href="css/compatibility.css">
    
    <!-- 内联关键CSS防闪烁 -->
    <style>
        /* 关键渲染路径CSS */
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: #f5f5f7;
            overflow-x: hidden;
        }
        #loading-screen { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: white; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 9999;
            flex-direction: column;
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007AFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-text {
            color: #666;
            font-size: 16px;
        }
        /* iOS安全区域适配 */
        @supports (padding: max(0px)) {
            .safe-area-top { padding-top: max(20px, env(safe-area-inset-top)); }
            .safe-area-bottom { padding-bottom: max(20px, env(safe-area-inset-bottom)); }
            .safe-area-left { padding-left: max(20px, env(safe-area-inset-left)); }
            .safe-area-right { padding-right: max(20px, env(safe-area-inset-right)); }
        }
    </style>
</head>
<body>
    <!-- 加载屏幕 -->
    <div id="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">正在加载...</div>
    </div>
    
    <!-- 应用容器 -->
    <div id="app-container" class="app-container">
        <!-- 导航容器 -->
        <div id="nav-container" class="nav-container safe-area-top safe-area-left"></div>
        
        <!-- 主内容区域 -->
        <main id="main-content" class="main-content">
            <!-- 面包屑导航 -->
            <div id="breadcrumb-container" class="breadcrumb-container"></div>
            
            <!-- 音频播放器 -->
            <div id="audio-container" class="audio-container">
                <audio id="audio-player" class="audio-player" preload="metadata" controls>
                    <source src="" type="audio/mpeg">
                    <p>您的浏览器不支持音频播放</p>
                </audio>
            </div>
            
            <!-- 内容显示区域 -->
            <div id="content-area" class="content-area safe-area-bottom">
                <div class="content-placeholder">
                    <h2>欢迎使用 LearnerEn</h2>
                    <p>请选择一个章节开始学习</p>
                </div>
            </div>
        </main>
        
        <!-- 返回顶部按钮 -->
        <button id="back-to-top" class="back-to-top" aria-label="返回顶部">↑</button>
        
        <!-- 离线提示 -->
        <div id="offline-notice" class="offline-notice" style="display: none;">
            <span>您当前处于离线状态</span>
        </div>
    </div>
    
    <!-- 全局错误边界 -->
    <div id="error-boundary" class="error-boundary" style="display: none;">
        <div class="error-content">
            <h3>应用遇到问题</h3>
            <p id="error-message">正在尝试恢复...</p>
            <button id="error-retry" class="error-retry-btn">重试</button>
        </div>
    </div>
    
    <!-- 脚本加载 -->
    <!-- Foundation Layer -->
    <script src="js/foundation/state-manager.js" defer></script>
    <script src="js/foundation/event-hub.js" defer></script>
    <script src="js/foundation/cache-manager.js" defer></script>
    <script src="js/foundation/error-boundary.js" defer></script>
    
    <!-- Utils -->
    <script src="js/utils/compatibility.js" defer></script>
    <script src="js/utils/dom-utils.js" defer></script>
    <script src="js/utils/mobile-utils.js" defer></script>
    <script src="js/utils/performance.js" defer></script>
    
    <!-- Core Modules -->
    <script src="js/modules/navigation-core.js" defer></script>
    <script src="js/modules/audio-sync-core.js" defer></script>
    <script src="js/modules/glossary-core.js" defer></script>
    <script src="js/modules/word-frequency-core.js" defer></script>
    <script src="js/modules/app-controller.js" defer></script>
    
    <!-- Main Application -->
    <script src="js/main.js" defer></script>
    
    <!-- 错误处理脚本 -->
    <script>
        // 全局错误捕获
        window.onerror = function(message, source, lineno, colno, error) {
            console.error('Global Error:', { message, source, lineno, colno, error });
            return false;
        };
        
        // Promise错误捕获
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled Promise Rejection:', event.reason);
        });
        
        // 网络状态监听
        window.addEventListener('online', function() {
            var notice = document.getElementById('offline-notice');
            if (notice) notice.style.display = 'none';
        });
        
        window.addEventListener('offline', function() {
            var notice = document.getElementById('offline-notice');
            if (notice) notice.style.display = 'block';
        });
        
        // 返回顶部功能
        document.addEventListener('DOMContentLoaded', function() {
            var backToTop = document.getElementById('back-to-top');
            var mainContent = document.getElementById('main-content');
            
            if (backToTop && mainContent) {
                backToTop.addEventListener('click', function() {
                    mainContent.scrollTo({ top: 0, behavior: 'smooth' });
                });
                
                mainContent.addEventListener('scroll', function() {
                    if (mainContent.scrollTop > 300) {
                        backToTop.style.display = 'block';
                    } else {
                        backToTop.style.display = 'none';
                    }
                });
            }
        });
    </script>
</body>
</html>